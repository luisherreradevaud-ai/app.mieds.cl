<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flujo de Trazabilidad - Barril.cl</title>
    <style>
        :root {
            --primary: #c9a227;
            --primary-dark: #a88620;
            --dark: #1a1a2e;
            --darker: #16213e;
            --light: #f5f5f5;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 100%);
            min-height: 100vh;
            color: var(--light);
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
        }

        h1 {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #888;
            font-size: 1.1rem;
        }

        .flow-section {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .flow-section h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
        }

        .flow-section h2 .icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        /* Flow Diagram */
        .flow-diagram {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            padding: 2rem 0;
        }

        .flow-step {
            background: linear-gradient(145deg, rgba(201,162,39,0.2), rgba(201,162,39,0.05));
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            text-align: center;
            min-width: 140px;
            transition: all 0.3s ease;
        }

        .flow-step:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(201,162,39,0.3);
        }

        .flow-step .step-number {
            background: var(--primary);
            color: var(--dark);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .flow-step .step-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .flow-step .step-entity {
            font-size: 0.8rem;
            color: #888;
        }

        .flow-arrow {
            color: var(--primary);
            font-size: 2rem;
            font-weight: bold;
        }

        /* Detailed Steps */
        .detailed-flow {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .detail-card {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid var(--primary);
        }

        .detail-card h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .detail-card h3 .num {
            background: var(--primary);
            color: var(--dark);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .detail-card ul {
            list-style: none;
            padding-left: 0;
        }

        .detail-card li {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }

        .detail-card li:last-child {
            border-bottom: none;
        }

        .detail-card .entity {
            color: var(--info);
            font-family: monospace;
        }

        .detail-card .field {
            color: var(--warning);
            font-family: monospace;
            font-size: 0.85rem;
        }

        .detail-card .file {
            color: var(--success);
            font-family: monospace;
            font-size: 0.85rem;
        }

        /* States Table */
        .states-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .state-card {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            overflow: hidden;
        }

        .state-card h4 {
            background: var(--primary);
            color: var(--dark);
            padding: 0.75rem 1rem;
            font-size: 1rem;
        }

        .state-list {
            padding: 1rem;
        }

        .state-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .state-item:last-child {
            border-bottom: none;
        }

        .state-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            min-width: 120px;
            text-align: center;
        }

        .state-badge.planta { background: var(--success); color: #fff; }
        .state-badge.despacho { background: var(--info); color: #fff; }
        .state-badge.terreno { background: var(--warning); color: #000; }
        .state-badge.perdido { background: var(--danger); color: #fff; }
        .state-badge.devuelto { background: #9b59b6; color: #fff; }
        .state-badge.envasado { background: #1abc9c; color: #fff; }
        .state-badge.caja { background: #3498db; color: #fff; }
        .state-badge.entregada { background: #27ae60; color: #fff; }

        .state-desc {
            font-size: 0.85rem;
            color: #aaa;
        }

        /* Critical Points */
        .critical-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .critical-table th,
        .critical-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .critical-table th {
            background: rgba(201,162,39,0.2);
            color: var(--primary);
            font-weight: 600;
        }

        .critical-table td {
            font-size: 0.9rem;
        }

        .critical-table .validation {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .validation.ok { background: var(--success); color: #fff; }
        .validation.warning { background: var(--warning); color: #000; }
        .validation.error { background: var(--danger); color: #fff; }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            color: #666;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            h1 {
                font-size: 1.75rem;
            }

            .flow-diagram {
                flex-direction: column;
            }

            .flow-arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Flujo Completo: Batch - Entrega</h1>
            <p class="subtitle">Sistema de Trazabilidad Barril.cl - Cerveza Cocholgue</p>
        </header>

        <!-- FLUJO DE BARRILES -->
        <section class="flow-section">
            <h2><span class="icon">&#127866;</span> Flujo de Barriles</h2>

            <div class="flow-diagram">
                <div class="flow-step">
                    <div class="step-number">1</div>
                    <div class="step-title">Produccion</div>
                    <div class="step-entity">Batch</div>
                </div>
                <span class="flow-arrow">&#8594;</span>
                <div class="flow-step">
                    <div class="step-number">2</div>
                    <div class="step-title">Fermentador</div>
                    <div class="step-entity">BatchActivo</div>
                </div>
                <span class="flow-arrow">&#8594;</span>
                <div class="flow-step">
                    <div class="step-number">3</div>
                    <div class="step-title">Llenar Barril</div>
                    <div class="step-entity">Barril</div>
                </div>
                <span class="flow-arrow">&#8594;</span>
                <div class="flow-step">
                    <div class="step-number">4</div>
                    <div class="step-title">Despacho</div>
                    <div class="step-entity">DespachoProducto</div>
                </div>
                <span class="flow-arrow">&#8594;</span>
                <div class="flow-step">
                    <div class="step-number">5</div>
                    <div class="step-title">Entrega</div>
                    <div class="step-entity">EntregaProducto</div>
                </div>
                <span class="flow-arrow">&#8594;</span>
                <div class="flow-step">
                    <div class="step-number">6</div>
                    <div class="step-title">Devolucion</div>
                    <div class="step-entity">Barril</div>
                </div>
            </div>

            <div class="detailed-flow">
                <div class="detail-card">
                    <h3><span class="num">1</span> Produccion</h3>
                    <ul>
                        <li><strong>Archivo:</strong> <span class="file">nuevo-batches.php</span></li>
                        <li><strong>Entidad:</strong> <span class="entity">Batch</span></li>
                        <li><strong>Campos:</strong> <span class="field">id_recetas, batch_nombre, etapa_seleccionada</span></li>
                        <li>Fermentacion - Maduracion</li>
                    </ul>
                </div>
                <div class="detail-card">
                    <h3><span class="num">2</span> Fermentador</h3>
                    <ul>
                        <li><strong>Archivo:</strong> <span class="file">inventario-de-productos.php</span></li>
                        <li><strong>Entidad:</strong> <span class="entity">BatchActivo</span></li>
                        <li><strong>Campos:</strong> <span class="field">id_batches, id_activos, litraje</span></li>
                        <li>Estado: Fermentacion - Maduracion</li>
                    </ul>
                </div>
                <div class="detail-card">
                    <h3><span class="num">3</span> Llenar Barril</h3>
                    <ul>
                        <li><strong>Archivo:</strong> <span class="file">ajax_llenarBarriles.php</span></li>
                        <li><strong>Entidad:</strong> <span class="entity">Barril</span></li>
                        <li><strong>Campos:</strong> <span class="field">litros_cargados, id_batches, id_activos, id_batches_activos</span></li>
                        <li>Estado: En planta</li>
                    </ul>
                </div>
                <div class="detail-card">
                    <h3><span class="num">4</span> Despacho</h3>
                    <ul>
                        <li><strong>Archivo:</strong> <span class="file">ajax_guardarDespacho.php</span></li>
                        <li><strong>Entidad:</strong> <span class="entity">Despacho + DespachoProducto</span></li>
                        <li><strong>Campos:</strong> <span class="field">tipo: 'Barril', id_barriles, id_productos</span></li>
                        <li>Barril.estado = 'En despacho'</li>
                    </ul>
                </div>
                <div class="detail-card">
                    <h3><span class="num">5</span> Entrega</h3>
                    <ul>
                        <li><strong>Archivo:</strong> <span class="file">ajax_guardarEntrega.php</span></li>
                        <li><strong>Entidad:</strong> <span class="entity">Entrega + EntregaProducto</span></li>
                        <li><strong>Campos:</strong> <span class="field">id_clientes, monto, factura</span></li>
                        <li>Barril.estado = 'En terreno'</li>
                        <li>DTE generado si cliente.emite_factura</li>
                    </ul>
                </div>
                <div class="detail-card">
                    <h3><span class="num">6</span> Devolucion</h3>
                    <ul>
                        <li><strong>Archivo:</strong> <span class="file">repartidor.php</span></li>
                        <li><strong>Entidad:</strong> <span class="entity">Barril</span></li>
                        <li>Estado: 'Devuelto a planta' - 'En planta'</li>
                        <li><span class="field">id_clientes = 0, id_batches = 0, litros_cargados = 0</span></li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- FLUJO DE ENVASES -->
        <section class="flow-section">
            <h2><span class="icon">&#129379;</span> Flujo de Envases (Latas y Botellas)</h2>

            <div class="flow-diagram">
                <div class="flow-step">
                    <div class="step-number">1</div>
                    <div class="step-title">Produccion</div>
                    <div class="step-entity">BatchActivo</div>
                </div>
                <span class="flow-arrow">&#8594;</span>
                <div class="flow-step">
                    <div class="step-number">2</div>
                    <div class="step-title">Origen</div>
                    <div class="step-entity">Fermentador/Barril</div>
                </div>
                <span class="flow-arrow">&#8594;</span>
                <div class="flow-step">
                    <div class="step-number">3</div>
                    <div class="step-title">Envasar</div>
                    <div class="step-entity">BatchDeEnvases</div>
                </div>
                <span class="flow-arrow">&#8594;</span>
                <div class="flow-step">
                    <div class="step-number">4</div>
                    <div class="step-title">Crear Caja</div>
                    <div class="step-entity">CajaDeEnvases</div>
                </div>
                <span class="flow-arrow">&#8594;</span>
                <div class="flow-step">
                    <div class="step-number">5</div>
                    <div class="step-title">Despacho</div>
                    <div class="step-entity">DespachoProducto</div>
                </div>
                <span class="flow-arrow">&#8594;</span>
                <div class="flow-step">
                    <div class="step-number">6</div>
                    <div class="step-title">Entrega</div>
                    <div class="step-entity">EntregaProducto</div>
                </div>
            </div>

            <div class="detailed-flow">
                <div class="detail-card">
                    <h3><span class="num">3</span> Envasar</h3>
                    <ul>
                        <li><strong>Archivo:</strong> <span class="file">ajax_envasar.php</span></li>
                        <li><strong>Entidad:</strong> <span class="entity">BatchDeEnvases</span> (1 por linea)</li>
                        <li><strong>Campos:</strong> <span class="field">tipo, id_batches, id_formatos_de_envases, cantidad_de_envases</span></li>
                        <li>Crea N registros individuales en <span class="entity">Envase</span></li>
                        <li>Origen vaciado (litraje = 0)</li>
                    </ul>
                </div>
                <div class="detail-card">
                    <h3><span class="num">4</span> Crear Caja</h3>
                    <ul>
                        <li><strong>Archivo:</strong> <span class="file">ajax_crearCajaDeEnvases.php</span></li>
                        <li><strong>Entidad:</strong> <span class="entity">CajaDeEnvases</span></li>
                        <li><strong>Codigo:</strong> <span class="field">CAJA-YYMMDD-XXXX</span></li>
                        <li>Envase.id_cajas_de_envases = caja.id</li>
                        <li>Envase.estado = 'En caja'</li>
                        <li>Soporta cajas mixtas (multiples recetas)</li>
                    </ul>
                </div>
                <div class="detail-card">
                    <h3><span class="num">5</span> Despacho</h3>
                    <ul>
                        <li><strong>Archivo:</strong> <span class="file">ajax_guardarDespacho.php</span></li>
                        <li><strong>Entidad:</strong> <span class="entity">DespachoProducto</span></li>
                        <li><strong>Tipo:</strong> <span class="field">'CajaEnvases'</span></li>
                        <li><strong>Campos:</strong> <span class="field">id_cajas_de_envases, id_productos</span></li>
                        <li>CajaDeEnvases.estado = 'En despacho'</li>
                    </ul>
                </div>
                <div class="detail-card">
                    <h3><span class="num">6</span> Entrega</h3>
                    <ul>
                        <li><strong>Archivo:</strong> <span class="file">ajax_guardarEntrega.php</span></li>
                        <li><strong>Entidad:</strong> <span class="entity">EntregaProducto</span></li>
                        <li>CajaDeEnvases.estado = 'Entregada'</li>
                        <li>DTE: "Lata xN [Producto]"</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- ESTADOS -->
        <section class="flow-section">
            <h2><span class="icon">&#128203;</span> Estados de Entidades</h2>

            <div class="states-grid">
                <div class="state-card">
                    <h4>Barril</h4>
                    <div class="state-list">
                        <div class="state-item">
                            <span class="state-badge planta">En planta</span>
                            <span class="state-desc">Vacio, disponible</span>
                        </div>
                        <div class="state-item">
                            <span class="state-badge despacho">En despacho</span>
                            <span class="state-desc">En camion</span>
                        </div>
                        <div class="state-item">
                            <span class="state-badge terreno">En terreno</span>
                            <span class="state-desc">Con cliente</span>
                        </div>
                        <div class="state-item">
                            <span class="state-badge perdido">Pinchado</span>
                            <span class="state-desc">Danado</span>
                        </div>
                        <div class="state-item">
                            <span class="state-badge perdido">Perdido</span>
                            <span class="state-desc">Extraviado</span>
                        </div>
                        <div class="state-item">
                            <span class="state-badge devuelto">Devuelto a planta</span>
                            <span class="state-desc">Retornado</span>
                        </div>
                    </div>
                </div>

                <div class="state-card">
                    <h4>Envase</h4>
                    <div class="state-list">
                        <div class="state-item">
                            <span class="state-badge envasado">Envasado</span>
                            <span class="state-desc">Individual creado</span>
                        </div>
                        <div class="state-item">
                            <span class="state-badge caja">En caja</span>
                            <span class="state-desc">Asignado a caja</span>
                        </div>
                        <div class="state-item">
                            <span class="state-badge despacho">En despacho</span>
                            <span class="state-desc">Caja en camion</span>
                        </div>
                        <div class="state-item">
                            <span class="state-badge entregada">Entregada</span>
                            <span class="state-desc">Con cliente</span>
                        </div>
                    </div>
                </div>

                <div class="state-card">
                    <h4>CajaDeEnvases</h4>
                    <div class="state-list">
                        <div class="state-item">
                            <span class="state-badge planta">En planta</span>
                            <span class="state-desc">Disponible</span>
                        </div>
                        <div class="state-item">
                            <span class="state-badge despacho">En despacho</span>
                            <span class="state-desc">En camion</span>
                        </div>
                        <div class="state-item">
                            <span class="state-badge entregada">Entregada</span>
                            <span class="state-desc">Con cliente</span>
                        </div>
                        <div class="state-item">
                            <span class="state-badge perdido">eliminado</span>
                            <span class="state-desc">Soft delete</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PUNTOS CRITICOS -->
        <section class="flow-section">
            <h2><span class="icon">&#9888;</span> Puntos Criticos de Trazabilidad</h2>

            <table class="critical-table">
                <thead>
                    <tr>
                        <th>Punto</th>
                        <th>Origen</th>
                        <th>Destino</th>
                        <th>Campos Criticos</th>
                        <th>Validacion</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Batch - BatchActivo</td>
                        <td>Batch</td>
                        <td>BatchActivo</td>
                        <td><span class="field">id_batches, id_activos</span></td>
                        <td><span class="validation ok">Activo disponible</span></td>
                    </tr>
                    <tr>
                        <td>BatchActivo - Barril</td>
                        <td>BatchActivo</td>
                        <td>Barril</td>
                        <td><span class="field">id_batches, id_activos, litros</span></td>
                        <td><span class="validation warning">Sin validar capacidad</span></td>
                    </tr>
                    <tr>
                        <td>BatchActivo - BatchDeEnvases</td>
                        <td>BatchActivo</td>
                        <td>BatchDeEnvases</td>
                        <td><span class="field">id_batches, id_activos, id_recetas</span></td>
                        <td><span class="validation ok">Volumen disponible</span></td>
                    </tr>
                    <tr>
                        <td>Barril - BatchDeEnvases</td>
                        <td>Barril</td>
                        <td>BatchDeEnvases</td>
                        <td><span class="field">id_batches, id_barriles</span></td>
                        <td><span class="validation ok">Volumen disponible</span></td>
                    </tr>
                    <tr>
                        <td>Envase - CajaDeEnvases</td>
                        <td>Envase</td>
                        <td>CajaDeEnvases</td>
                        <td><span class="field">id_cajas_de_envases</span></td>
                        <td><span class="validation ok">Formato coincide</span></td>
                    </tr>
                    <tr>
                        <td>Barril - DespachoProducto</td>
                        <td>Barril</td>
                        <td>DespachoProducto</td>
                        <td><span class="field">id_barriles, id_productos</span></td>
                        <td><span class="validation ok">Estado correcto</span></td>
                    </tr>
                    <tr>
                        <td>Caja - DespachoProducto</td>
                        <td>CajaDeEnvases</td>
                        <td>DespachoProducto</td>
                        <td><span class="field">id_cajas_de_envases, id_productos</span></td>
                        <td><span class="validation warning">id_productos era 0 (mitigado)</span></td>
                    </tr>
                    <tr>
                        <td>DespachoProducto - EntregaProducto</td>
                        <td>DespachoProducto</td>
                        <td>EntregaProducto</td>
                        <td><span class="field">Todos los campos</span></td>
                        <td><span class="validation ok">Copia completa</span></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <footer>
            <p>Barril.cl - Sistema de Gestion para Cerveceria</p>
            <p>Cerveza Cocholgue - Chile</p>
            <p style="margin-top: 0.5rem; font-size: 0.85rem;">Documento generado: 2025-11-29</p>
        </footer>
    </div>
</body>
</html>
